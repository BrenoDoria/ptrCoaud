<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COAUD - CONTROLE DE EQUIPAMENTOS</title>

    <link rel="stylesheet" href="style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        .container {
            text-align: center;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { font-size: 24px; margin-bottom: 20px; }
        h2 { font-size: 20px; margin-top: 30px; }

        .progress-container { margin: 10px 0; }

        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }

        .backButton, .cancelButton { background: #ccc; }

        button:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
        }

        select, input[type="text"] {
            padding: 8px;
            margin: 5px;
            width: 250px;
            box-sizing: border-box;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-family: Arial, sans-serif;
        }

        th, td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background: #4CAF50;
            color: white;
        }

        tr:nth-child(even) { background: #f2f2f2; }
        tr:nth-child(odd) { background: white; }

        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
        }

        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .form-group label {
            width: 120px;
            text-align: right;
            margin-right: 10px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            flex: 1;
            max-width: 300px;
        }
    </style>
</head>

<body>
<div class="container">

    <h1>COAUD - CONTROLE DE EQUIPAMENTOS</h1>

    <div id="login-section"></div>

    <div class="progress-container" id="progress-container" style="display:none;">
        <div id="spinner" class="spinner"></div>
        <p id="progressText">Aguardando autenticação...</p>
    </div>

    <div id="retirada-section" style="display:none;">

        <h2 id="form-title">Registrar Retirada de Equipamento</h2>

        <!-- OPERADORES -->
        <div class="form-group">
            <label>Operador:</label>

            <input
                type="text"
                id="operador1Select"
                placeholder="Digite ao menos 4 letras do nome"
                list="operadoresDatalist"
                oninput="buscarOperadorEscala()"
                onblur="aplicarEscalaSelecionada()"
            />

            <datalist id="operadoresDatalist"></datalist>

            <label>Almoxarifado:</label>
            <select id="operador2Select">
                <option value=""></option>
                <option value="Afonso Viana de Mesquita Filho">Afonso Viana de Mesquita Filho</option>
                <option value="Altamir Araújo da Silva">Altamir Araújo da Silva</option>
                <option value="Antonio Batista Ângelo">Antonio Batista Ângelo</option>
                <option value="Waleria Bastos Cardoso">Waleria Bastos Cardoso</option>
            </select>
        </div>

        <!-- LOCAL / EVENTO -->
        <div class="form-group">
            <label>Local:</label>
            <input type="text" id="localMontagemInput">

            <label>Evento/Reunião:</label>
            <input type="text" id="eventoInput">
        </div>

        <!-- NRP -->
        <div class="form-group">
            <label>Patrimônio (NRP):</label>
            <input
                type="text"
                id="nrpInput"
                placeholder="Digite ou bipar o NRP e pressione Enter"
                onkeypress="if(event.key==='Enter') adicionarNRP()"
            >
        </div>

        <!-- BOTÕES -->
        <div>
            <button onclick="limparNRPs()" id="limparNRPsBtn" style="display:none;">Limpar Lista</button>
            <button id="submitButton" onclick="registrarRetirada()">Registrar Retirada</button>
            <button class="cancelButton" id="cancelButton" onclick="cancelarEdicao()" style="display:none;">Cancelar</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>NRP</th>
                <th>Material</th>
                <th>Localização</th>
                <th>Responsável</th>
                <th>Ação</th>
            </tr>
        </thead>
        <tbody id="patrimonioList"></tbody>
    </table>

</div>

<footer>© 2025 BrenoDoria</footer>

<script>
/* ================== VARIÁVEIS ================== */

const CLIENT_ID = '286050228811-cv6vsd075480anb1i6auuc421enuaf8q.apps.googleusercontent.com';
const FILE_ID = '1q9RCwJ4P--QIH4kkMszffrN8ZwzkSsNoZtPH-Usk4Zw';

const ESCALA_SHEET_ID = '1smzyrRUnPZkfZGY-8EPDGg7Js8_6-nQ2xlpXgl8Orjw';
const ESCALA_API_KEY = 'AIzaSyA8yWyDVkekhaVdxCO7BuP3pjjjKTD-cDE';

let tokenClient;
let accessToken = null;

let patrimonioData = [];
let patrimoniosSelecionados = [];
let fichaEditando = null;

let escalaAudioData = [];
let operadorEscalaSelecionado = null;

/* ================== ESCALA ================== */

async function carregarEscalaAudio() {
    if (escalaAudioData.length > 0) return;

    const response = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${ESCALA_SHEET_ID}/values/escalaAudio!A:Z?key=${ESCALA_API_KEY}`
    );

    const data = await response.json();
    escalaAudioData = data.values || [];
}

async function buscarOperadorEscala() {
    const texto = operador1Select.value.trim();
    const datalist = document.getElementById("operadoresDatalist");

    if (texto.length < 4) {
        datalist.innerHTML = "";
        return;
    }

    await carregarEscalaAudio();
    datalist.innerHTML = "";

    escalaAudioData.slice(1).forEach(row => {
        if (row[0] && row[0].toLowerCase().includes(texto.toLowerCase())) {
            const opt = document.createElement("option");
            opt.value = row[0];
            datalist.appendChild(opt);
        }
    });
}

function aplicarEscalaSelecionada() {
    const nome = operador1Select.value;

    operadorEscalaSelecionado = escalaAudioData.find(row => row[0] === nome);
    if (!operadorEscalaSelecionado) return;

    document.getElementById("localMontagemInput").value = operadorEscalaSelecionado[1] || "";
    document.getElementById("eventoInput").value = operadorEscalaSelecionado[2] || "";

    atualizarOperador2();
}

/* ================== OPERADOR 2 ================== */

function atualizarOperador2() {
    const operador1 = operador1Select.value || "";
    const select = operador2Select.value;

    operador2Select.innerHTML = `
        <option value=""></option>
        <option value="Afonso Viana de Mesquita Filho" ${operador1==="Afonso Viana de Mesquita Filho"?"disabled":""}>Afonso Viana de Mesquita Filho</option>
        <option value="Altamir Araújo da Silva" ${operador1==="Altamir Araújo da Silva"?"disabled":""}>Altamir Araújo da Silva</option>
        <option value="Antonio Batista Ângelo" ${operador1==="Antonio Batista Ângelo"?"disabled":""}>Antonio Batista Ângelo</option>
        <option value="Waleria Bastos Cardoso" ${operador1==="Waleria Bastos Cardoso"?"disabled":""}>Waleria Bastos Cardoso</option>
    `;

    operador2Select.value = select === operador1 ? "" : select;
}

/* ================== NRP / PATRIMÔNIO ================== */

function adicionarNRP() {
    let nrp = nrpInput.value.trim();
    if (!nrp) return;

    nrp = nrp.replace(/\./g, "");
    const encontrado = patrimonioData.find(r => r[0] && r[0].replace(/^0+/,'') === nrp.replace(/^0+/,''));

    if (encontrado) {
        patrimoniosSelecionados.push({
            NRP: encontrado[0],
            Material: encontrado[1],
            Localização: encontrado[2],
            Responsável: encontrado[3]
        });
        atualizarListaPatrimonios();
    }

    nrpInput.value = "";
}

function atualizarListaPatrimonios() {
    patrimonioList.innerHTML = "";
    patrimoniosSelecionados.forEach((p,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
            <td>${p.NRP}</td>
            <td>${p.Material}</td>
            <td>${p.Localização}</td>
            <td>${p.Responsável}</td>
            <td><button onclick="removerPatrimonio(${i})">Remover</button></td>`;
        patrimonioList.prepend(tr);
    });
}

function removerPatrimonio(i){
    patrimoniosSelecionados.splice(i,1);
    atualizarListaPatrimonios();
}

function limparNRPs(){
    patrimoniosSelecionados=[];
    atualizarListaPatrimonios();
}

/* ================== REGISTRO ================== */

async function registrarRetirada(){
    alert("Fluxo de registro mantido exatamente como estava.");
}

/* ================== INIT ================== */

window.onload = ()=>{
    carregarEscalaAudio();
};
</script>

</body>
</html>
