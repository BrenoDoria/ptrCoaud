<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COAUD - CONTROLE DE EQUIPAMENTOS</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .container {
            text-align: center;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 20px;
            margin-top: 30px;
        }
        .progress-container {
            margin: 10px 0;
        }
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        .backButton, .cancelButton {
            background: #ccc;
        }
        button:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
        }
        select, input[type="text"] {
            padding: 8px;
            margin: 5px;
            width: 250px;
            box-sizing: border-box;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-family: Arial, sans-serif;
        }
        th, td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        th {
            background: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background: #f2f2f2;
        }
        tr:nth-child(odd) {
            background: white;
        }
        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
        }
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 50px;
            flex-wrap: wrap;
        }
        .form-group label {
            width: 120px;
            text-align: right;
            margin-right: 10px;
            font-weight: bold;
        }
        .form-group select, .form-group input[type="text"] {
            flex: 1;
            max-width: 300px;
        }

        /* Autocomplete personalizado */
        .autocomplete-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 300px;
        }
        #operador1Input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>COAUD - CONTROLE DE EQUIPAMENTOS</h1>
        <div id="login-section">
            <button onclick="solicitarToken()">Fazer Login com Google</button>
        </div>
        <div class="progress-container" id="progress-container" style="display: none;">
            <div id="spinner" class="spinner"></div>
            <p id="progressText">Aguardando autenticação...</p>
        </div>
        <div id="retirada-section" style="display: none;">
            <h2 id="form-title">Registrar Retirada de Equipamento</h2>
            <div class="form-group">
                <label>Operador:</label>
                <div class="autocomplete-wrapper">
                    <input type="text" id="operador1Input" placeholder="Digite as letras iniciais do nome" autocomplete="off">
                    <div id="autocompleteList" class="autocomplete-list"></div>
                </div>
                <label>Almoxarifado:</label>
                <select id="operador2Select">
                    <option value=""></option>
                    <option value="Afonso Viana de Mesquita Filho">Afonso Viana de Mesquita Filho</option>
                    <option value="Altamir Araújo da Silva">Altamir Araújo da Silva</option>
                    <option value="Antonio Batista Ângelo">Antonio Batista Ângelo</option>
                    <option value="Waleria Bastos Cardoso">Waleria Bastos Cardoso</option>
                </select>
            </div>
            <div class="form-group">
                <label>Local:</label>
                <input type="text" id="localMontagemInput" placeholder="Ex.: Sala 101">
                <label>Evento/Reunião:</label>
                <input type="text" id="eventoInput" placeholder="Ex.: Reunião Mensal">
            </div>
            <div class="form-group">
                <label>Patrimônio (NRP):</label>
                <input type="text" id="nrpInput" placeholder="Digite ou bipar o NRP e pressione Enter" onkeypress="if(event.key === 'Enter') adicionarNRP()">
            </div>
            <div id="action-buttons">
                <button onclick="limparNRPs()" style="display: none;" id="limparNRPsBtn">Limpar Lista</button>
                <button id="submitButton" onclick="registrarRetirada()">Registrar Retirada</button>
                <button id="cancelButton" class="cancelButton" onclick="cancelarEdicao()" style="display: none;">Cancelar Edição</button>
            </div>
        </div>
        <div id="navegacao-fichas" style="display: none;">
            <button id="fichasPendentesBtn" onclick="navigateTo('fichas.html')">Fichas Pendentes</button>
            <button id="fichasArquivadasBtn" onclick="navigateTo('fichas-arquivadas.html')">Fichas Arquivadas</button>
        </div>
        <button id="backButton" class="backButton" onclick="navigateTo('index.html')">Voltar</button>
        <table id="patrimonioTable">
            <thead>
                <tr>
                    <th>NRP</th>
                    <th>Material</th>
                    <th>Localização</th>
                    <th>Responsável</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody id="patrimonioList"></tbody>
        </table>
    </div>
    <footer class="author-signature">© 2025 BrenoDoria</footer>

    <script>
        const usuarios = {
            "supervisor": { senha: "12345", permissao: "Supervisor" },
            "operador": { senha: "12345", permissao: "Operador" }
        };
        const CLIENT_ID = '286050228811-cv6vsd075480anb1i6auuc421enuaf8q.apps.googleusercontent.com';
        const FILE_ID = '1q9RCwJ4P--QIH4kkMszffrN8ZwzkSsNoZtPH-Usk4Zw';
        const ESCALA_SHEET_ID = '1smzyrRUnPZkfZGY-8EPDGg7Js8_6-nQ2xlpXgl8Orjw';
        const API_KEY = 'AIzaSyA8yWyDVkekhaVdxCO7BuP3pjjjKTD-cDE';
        let tokenClient;
        let accessToken = null;
        let patrimonioData = [];
        let patrimoniosSelecionados = [];
        let fichaEditando = null;
        let escalaData = [];

        // Lista completa de operadores (mantida igual)
        const operadoresList = [
            "Adson Miranda dos Anjos",
            "Afonso Viana de Mesquita Filho",
            "Alberto Cesar Souza Almeida",
            "Alexander Rafael Carvalho Paim",
            "Alison Silva de Oliveira",
            "Allan Cosseti Ardisson",
            "Altamir Araujo da Silva",
            "Antonio Batista Ângelo",
            "Antonio Rodrigues Siqueira Filho",
            "Arley Carvalho Alves",
            "Breno Doria Felicio",
            "Bruno Fernandes Braga",
            "Bruno Rodrigues do Prado",
            "Bruno Vieira Rodrigues",
            "Carlos Cesar José da Silva",
            "Carlos Eduardo Guedes da Silva",
            "Carlos Roberto de Paiva Miranda dos Santos",
            "Cinthia Neves Carvalho Barbosa",
            "Cláudio Marcelo do Nascimento",
            "Davi Aragão de Paula Gonçalves",
            "Douglas Batista da Silva",
            "Emmanuel do Amaral Idelfonso",
            "Emanuel Silveira Costa",
            "Eric Samuel do Ouro",
            "Erika Fedosseeff Auler",
            "Eromilson Monteiro Dutra Chaves",
            "Evel lyn Mendes de Souza Nunes",
            "Felipe Omena Vasconcellos de Assis",
            "Fernando de Sousa Vasconcelos",
            "Flávio Lima Câmara",
            "Francisco de Assis da Silva Sales",
            "Francisco de Sousa Filho",
            "Francisco Juniel Sousa e Silva",
            "Geraldo Ribeiro de Souza Filho",
            "Gildo Marques da Silva",
            "Gilson Gomes da Silva",
            "Gleisson Carlos Pereira da Silva",
            "Guilherme Malheiro da Rocha Pinto",
            "Helisson Rafael de O. Leite",
            "Helyeber Feitosa Ferreira",
            "Huelisson Amancio de Moraes Silva",
            "Igor Mendes dos Santos",
            "Isaias Pereira Soares",
            "Joel Luiz de Sá Silva",
            "Joel Pereira Santos",
            "Jônatas Soares de Andrade",
            "Jose Henrique Ferreira da Silva",
            "Jose Leandro Marques",
            "José Nilton Abraão de Sousa",
            "Josue Cardoso Abreu",
            "Joval Bastos Freitas Júnior",
            "Juliano Gustavo Pedro de Oliveira",
            "Kely Berlinck Freire",
            "Kleber de Araújo Moura",
            "Leandro Calixto da Silva",
            "Leandro Silva Lima Alves",
            "Leonardo Augusto de Freitas",
            "Letícia Santana Araújo",
            "Lívia Maria de Souza",
            "Lucas Lima Lira",
            "Lucas Ribeiro dos Santos",
            "Luciano de Freitas Silva",
            "Luiz Henrique Reis de Lima",
            "Marcelo Gomes da Silva",
            "Marco Antonio Baldresca Lambert de Brito",
            "Marco Antônio Felício Júnior",
            "Marcos Borges de Souza",
            "Marcus Aurélius Fernandes de Moura",
            "Massilon Alves de Sousa Filho",
            "Mateus da Silva Lima",
            "Matheus Gabriel Damasceno Dias",
            "Matheus Henrique Felix Barbosa",
            "Múcio Homero Rocha Pires de Oliveira",
            "Orlando Villavicencio Venegas",
            "Otoniel Alves de Souza",
            "Paulo Fernando Volpe",
            "Paulo Roberto Pereira",
            "Paulo Soares da Costa",
            "Pedro Henrique Candido Boaventura",
            "Péricles Cruz da Silva",
            "Rafael Queiroz Lemos de Oliveira",
            "Reynaldo Jessé Rodrigues da Silva",
            "Richard Rodrigues dos Santos",
            "Roberio Antunes Simionato",
            "Rondney Rodrigues Alves Sousa",
            "Rosivan Augustinho Pereira",
            "Thiago Veríssimo Cabral Freitas",
            "Waleria Bastos Cardoso",
            "Wellington Jorge Souza Mendes",
            "Wendel Vieira da Costa",
            "Wesley Maurício Ribeiro França",
            "Willian Neves da Silva",
            "Wirlem Silva Alves"
        ];

        let currentFocus = -1;

        window.onload = () => {
            const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
            if (!usuarioLogado || !usuarios[usuarioLogado.username]) {
                alert("Usuário não está logado. Faça login novamente.");
                window.location.href = "index.html";
                return;
            }
            if (usuarios[usuarioLogado.username].permissao !== "Supervisor") {
                alert("Acesso negado: Você não tem permissão para acessar o Controle de Almoxarifado.");
                window.location.href = "index.html";
                return;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (tokenResponse) => {
                    if (tokenResponse.error) {
                        document.getElementById("progressText").textContent = "Erro ao autenticar: " + tokenResponse.error;
                        return;
                    }
                    accessToken = tokenResponse.access_token;
                    localStorage.setItem("access_token", accessToken);
                    document.getElementById("progressText").textContent = "Autenticado com sucesso! Carregando dados...";
                    document.getElementById("progress-container").style.display = "block";
                    document.getElementById("login-section").style.display = "none";
                    document.getElementById("retirada-section").style.display = "block";
                    document.getElementById("navegacao-fichas").style.display = "block";
                    carregarPatrimoniosDoSheets();
                    carregarEscala();
                }
            });

            const savedToken = localStorage.getItem("access_token");
            if (savedToken) {
                accessToken = savedToken;
                document.getElementById("login-section").style.display = "none";
                document.getElementById("retirada-section").style.display = "block";
                document.getElementById("navegacao-fichas").style.display = "block";
                document.getElementById("progress-container").style.display = "block";
                document.getElementById("progressText").textContent = "Usando token salvo. Carregando dados...";
                carregarPatrimoniosDoSheets();
                carregarEscala();
            } else {
                document.getElementById("login-section").style.display = "block";
                document.getElementById("retirada-section").style.display = "none";
                document.getElementById("navegacao-fichas").style.display = "none";
                document.getElementById("progress-container").style.display = "block";
            }

            // Configuração do autocomplete
            const input = document.getElementById("operador1Input");
            input.addEventListener("input", filtrarOperadores);
            input.addEventListener("keydown", navegarComTeclado);
            input.addEventListener("focus", () => { if (input.value.trim()) filtrarOperadores(); });
            document.addEventListener("click", (e) => {
                if (!input.contains(e.target) && !document.getElementById("autocompleteList").contains(e.target)) {
                    document.getElementById("autocompleteList").style.display = "none";
                }
            });

            const fichaParaEditar = JSON.parse(localStorage.getItem('fichaParaEditar'));
            if (fichaParaEditar) {
                fichaEditando = fichaParaEditar;
                document.getElementById("form-title").textContent = "Editar Ficha Pendente";
                document.getElementById("submitButton").textContent = "Salvar Alterações";
                document.getElementById("cancelButton").style.display = "inline-block";

                document.getElementById("operador1Input").value = fichaEditando.operador1;
                document.getElementById("operador2Select").value = fichaEditando.operador2;
                document.getElementById("localMontagemInput").value = fichaEditando.local;
                document.getElementById("eventoInput").value = fichaEditando.evento;
                patrimoniosSelecionados = fichaEditando.equipamentos.map(equip => {
                    const [nrp, ...materialParts] = equip.split(' - ');
                    return { NRP: nrp, Material: materialParts.join(' - ') };
                });
                atualizarListaPatrimonios();
                document.getElementById("limparNRPsBtn").style.display = patrimoniosSelecionados.length > 0 ? "inline-block" : "none";
                toggleNavigationButtons(true);
                atualizarOperador2();
            }
        };

        function filtrarOperadores() {
            const input = document.getElementById("operador1Input");
            const filter = input.value.toLowerCase().trim();
            const list = document.getElementById("autocompleteList");
            list.innerHTML = "";
            currentFocus = -1;

            if (!filter) {
                list.style.display = "none";
                return;
            }

            const matches = operadoresList.filter(nome => {
                const palavras = nome.toLowerCase().split(" ");
                return palavras.some(palavra => palavra.startsWith(filter));
            });

            if (matches.length === 0) {
                list.innerHTML = '<div class="autocomplete-item" style="color:#999;">Nenhum operador encontrado</div>';
                list.style.display = "block";
                return;
            }

            matches.forEach((nome, index) => {
                const item = document.createElement("div");
                item.classList.add("autocomplete-item");
                item.textContent = nome;
                item.onclick = () => selecionarOperador(nome);
                list.appendChild(item);
            });

            list.style.display = "block";
        }

        function navegarComTeclado(e) {
            const list = document.getElementById("autocompleteList");
            const items = list.getElementsByClassName("autocomplete-item");

            if (e.key === "ArrowDown") {
                e.preventDefault();
                currentFocus = (currentFocus + 1) % items.length;
                atualizarSelecao(items);
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                currentFocus = (currentFocus - 1 + items.length) % items.length;
                atualizarSelecao(items);
            } else if (e.key === "Enter") {
                e.preventDefault();
                if (currentFocus > -1 && items[currentFocus]) {
                    items[currentFocus].click();
                }
            }
        }

        function atualizarSelecao(items) {
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove("selected");
            }
            if (currentFocus > -1 && items[currentFocus]) {
                items[currentFocus].classList.add("selected");
                items[currentFocus].scrollIntoView({ block: "nearest" });
            }
        }

        function selecionarOperador(nome) {
            document.getElementById("operador1Input").value = nome;
            document.getElementById("autocompleteList").style.display = "none";
            selecionarOperador1(nome);
        }

        function selecionarOperador1(nomeSelecionado) {
            const operador1 = nomeSelecionado || document.getElementById("operador1Input").value;
            if (!operador1) {
                document.getElementById("localMontagemInput").value = "";
                document.getElementById("eventoInput").value = "";
                return;
            }

            let linhaOperador = null;
            for (let i = 1; i < escalaData.length; i++) {
                const row = escalaData[i];
                if (row[9]) {
                    const nomeNaEscala = normalizarNome(row[9].trim());
                    const nomeDigitado = normalizarNome(operador1);
                    if (nomeNaEscala === nomeDigitado) {
                        linhaOperador = row;
                        break;
                    }
                }
            }

            if (linhaOperador) {
                document.getElementById("localMontagemInput").value = linhaOperador[2]?.trim() || "";
                document.getElementById("eventoInput").value = linhaOperador[6]?.trim() || "";
                document.getElementById("progressText").textContent = `Operador ${operador1} encontrado na escala.`;
            } else {
                document.getElementById("localMontagemInput").value = "";
                document.getElementById("eventoInput").value = "";
                document.getElementById("progressText").textContent = `Operador ${operador1} não encontrado na escala. Digite manualmente.`;
            }
            atualizarOperador2();
        }

        function normalizarNome(nome) {
            return nome.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        // === RESTANTE DO CÓDIGO (mantido 100% igual ao original) ===

        function toggleNavigationButtons(disable) {
            document.getElementById("backButton").disabled = disable;
            document.getElementById("fichasPendentesBtn").disabled = disable;
            document.getElementById("fichasArquivadasBtn").disabled = disable;
        }

        function navigateTo(page) {
            if (fichaEditando) {
                document.getElementById("progressText").textContent = "Salve as alterações antes de navegar.";
                return;
            }
            window.location.href = page;
        }

        function cancelarEdicao() {
            fichaEditando = null;
            localStorage.removeItem('fichaParaEditar');
            toggleNavigationButtons(false);
            document.getElementById("form-title").textContent = "Registrar Retirada de Equipamento";
            document.getElementById("submitButton").textContent = "Registrar Retirada";
            document.getElementById("cancelButton").style.display = "none";
            document.getElementById("operador1Input").value = "";
            document.getElementById("operador2Select").value = "";
            document.getElementById("localMontagemInput").value = "";
            document.getElementById("eventoInput").value = "";
            patrimoniosSelecionados = [];
            atualizarListaPatrimonios();
            document.getElementById("limparNRPsBtn").style.display = "none";
            document.getElementById("autocompleteList").style.display = "none";
            atualizarOperador2();
        }

        function carregarEscala() {
            document.getElementById("progressText").textContent = "Carregando escala de eventos...";
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${ESCALA_SHEET_ID}/values/escalaAudio!A:Z?key=${API_KEY}`)
            .then(r => r.ok ? r.json() : Promise.reject("Erro na escala"))
            .then(data => {
                escalaData = data.values || [];
                document.getElementById("progressText").textContent = "Escala carregada.";
            })
            .catch(err => {
                console.error(err);
                document.getElementById("progressText").textContent = "Erro ao carregar escala.";
            });
        }

        function carregarPatrimoniosDoSheets(retryCount = 0) {
            const maxRetries = 3;
            document.getElementById("spinner").style.display = "inline-block";
            document.getElementById("progressText").textContent = "Consultando Servidor";
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/SIGMAS!A:D`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            })
            .then(async response => {
                if (!response.ok) {
                    if (response.status === 401 && retryCount < maxRetries) {
                        localStorage.removeItem("access_token");
                        document.getElementById("login-section").style.display = "block";
                        document.getElementById("retirada-section").style.display = "none";
                        document.getElementById("navegacao-fichas").style.display = "none";
                        solicitarToken();
                        return;
                    }
                    const err = await response.json();
                    throw new Error(err.error?.message || response.statusText);
                }
                return response.json();
            })
            .then(data => {
                patrimonioData = data.values || [];
                document.getElementById("progressText").textContent = "AUTORIZADA CONSULTA";
                document.getElementById("spinner").style.display = "none";
            })
            .catch(err => {
                console.error(err);
                document.getElementById("progressText").textContent = "Erro: " + err.message;
                document.getElementById("spinner").style.display = "none";
            });
        }

        function atualizarOperador2() {
            const operador1 = document.getElementById("operador1Input").value;
            const select = document.getElementById("operador2Select");
            const current = select.value;
            select.innerHTML = `
                <option value=""></option>
                <option value="Afonso Viana de Mesquita Filho" ${operador1 === "Afonso Viana de Mesquita Filho" ? "disabled" : ""}>Afonso Viana de Mesquita Filho</option>
                <option value="Altamir Araújo da Silva" ${operador1 === "Altamir Araújo da Silva" ? "disabled" : ""}>Altamir Araújo da Silva</option>
                <option value="Antonio Batista Ângelo" ${operador1 === "Antonio Batista Ângelo" ? "disabled" : ""}>Antonio Batista Ângelo</option>
                <option value="Waleria Bastos Cardoso" ${operador1 === "Waleria Bastos Cardoso" ? "disabled" : ""}>Waleria Bastos Cardoso</option>
            `;
            select.value = (operador1 === current) ? "" : current;
        }

        function adicionarNRP() {
            let nrp = document.getElementById("nrpInput").value.trim().replace(/\./g, "");
            if (!nrp) return;
            const nrpSemZeros = nrp.replace(/^0+/, "");
            if (!patrimoniosPermitidosParaRepeticao.includes(nrpSemZeros)) {
                if (patrimoniosSelecionados.some(p => p.NRP.replace(/^0+/, "") === nrpSemZeros)) {
                    document.getElementById("progressText").textContent = `NRP "${nrp}" já adicionado.`;
                    document.getElementById("nrpInput").value = "";
                    return;
                }
            }
            const encontrado = patrimonioData.find(row => row[0]?.toString().replace(/^0+/, "") === nrpSemZeros);
            if (encontrado) {
                patrimoniosSelecionados.push({
                    NRP: encontrado[0], Material: encontrado[1],
                    Localização: encontrado[2], Responsável: encontrado[3]
                });
                atualizarListaPatrimonios();
                document.getElementById("progressText").textContent = `NRP "${nrp}" adicionado.`;
            } else {
                document.getElementById("progressText").textContent = `NRP "${nrp}" não encontrado.`;
            }
            document.getElementById("nrpInput").value = "";
            document.getElementById("limparNRPsBtn").style.display = patrimoniosSelecionados.length > 0 ? "inline-block" : "none";
        }

        function atualizarListaPatrimonios() {
            const tbody = document.getElementById("patrimonioList");
            tbody.innerHTML = "";
            patrimoniosSelecionados.forEach((item, i) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${item.NRP}</td><td>${item.Material}</td><td>${item.Localização || "N/I"}</td><td>${item.Responsável || "N/I"}</td>
                    <td><button onclick="removerPatrimonio(${i})">Remover</button></td>`;
                tbody.prepend(tr);
            });
        }

        function removerPatrimonio(i) {
            patrimoniosSelecionados.splice(i, 1);
            atualizarListaPatrimonios();
            document.getElementById("limparNRPsBtn").style.display = patrimoniosSelecionados.length > 0 ? "inline-block" : "none";
        }

        function limparNRPs() {
            patrimoniosSelecionados = [];
            atualizarListaPatrimonios();
            document.getElementById("limparNRPsBtn").style.display = "none";
        }

        function solicitarToken() {
            tokenClient.requestAccessToken();
        }

        const patrimoniosPermitidosParaRepeticao = ["99010001","99010002","99010003","99010004","99010005","99010006","99010007","99010008","99010009","99010010",
            "99010011","99010012","99010013","99010014","99010015","99010016","99010017","99010018","99010019","99010020",
            "99010021","99010022","99010023","99010024","99010025","99030001","99030002","99040001","99020001","99020002",
            "99020003","99020004","99040002","99040003","99030003","99030004","99030005","99030006","99040004","99030011"];

        async function registrarRetirada() {
            const operador1 = document.getElementById("operador1Input").value.trim();
            const operador2 = document.getElementById("operador2Select").value;
            const localMontagem = document.getElementById("localMontagemInput").value.trim();
            const evento = document.getElementById("eventoInput").value.trim();
            const dataRetirada = fichaEditando ? fichaEditando.dataRetirada : new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });

            if (!operador1 || patrimoniosSelecionados.length === 0 || !localMontagem || !evento) {
                document.getElementById("progressText").textContent = "Preencha todos os campos obrigatórios.";
                return;
            }

            const equipamentos = patrimoniosSelecionados.map(i => `${i.NRP} - ${i.Material}`).join("; ");
            const novaLinha = [fichaEditando ? fichaEditando.idFicha : Date.now().toString(), operador1, operador2, equipamentos, localMontagem, evento, dataRetirada];

            document.getElementById("spinner").style.display = "inline-block";
            document.getElementById("progressText").textContent = fichaEditando ? "Salvando alterações..." : "Registrando retirada...";

            try {
                // Verifica conflito de NRP
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/RETIRADAS_PENDENTES!A:G`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.values && data.values.length > 1) {
                        const usados = [];
                        data.values.slice(1).forEach((row, idx) => {
                            if (fichaEditando && (idx + 1) === fichaEditando.rowIndex) return;
                            const eqs = row[3]?.split("; ") || [];
                            eqs.forEach(e => {
                                const nrp = e.split(" - ")[0]?.replace(/^0+/, "");
                                if (nrp) usados.push(nrp);
                            });
                        });
                        const conflito = patrimoniosSelecionados.find(p => {
                            const n = p.NRP.replace(/^0+/, "");
                            return usados.includes(n) && !patrimoniosPermitidosParaRepeticao.includes(n);
                        });
                        if (conflito) {
                            alert(`O patrimônio ${conflito.NRP} já está em uso em outra ficha pendente.`);
                            document.getElementById("spinner").style.display = "none";
                            return;
                        }
                    }
                }

                if (fichaEditando) {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/RETIRADAS_PENDENTES!A${fichaEditando.rowIndex + 1}:G${fichaEditando.rowIndex + 1}?valueInputOption=RAW`, {
                        method: 'PUT', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [novaLinha] })
                    });
                    localStorage.removeItem('fichaParaEditar');
                    document.getElementById("progressText").textContent = "Ficha atualizada com sucesso!";
                } else {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/RETIRADAS_PENDENTES!A:G:append?valueInputOption=RAW`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [novaLinha] })
                    });
                    document.getElementById("progressText").textContent = "Retirada registrada com sucesso!";
                }

                // Limpar formulário
                document.getElementById("operador1Input").value = "";
                document.getElementById("operador2Select").value = "";
                document.getElementById("localMontagemInput").value = "";
                document.getElementById("eventoInput").value = "";
                patrimoniosSelecionados = [];
                atualizarListaPatrimonios();
                document.getElementById("limparNRPsBtn").style.display = "none";
                document.getElementById("form-title").textContent = "Registrar Retirada de Equipamento";
                document.getElementById("submitButton").textContent = "Registrar Retirada";
                document.getElementById("cancelButton").style.display = "none";
                fichaEditando = null;
                toggleNavigationButtons(false);
                document.getElementById("spinner").style.display = "none";

            } catch (err) {
                document.getElementById("progressText").textContent = "Erro: " + err.message;
                document.getElementById("spinner").style.display = "none";
            }
        }
        setInterval(() => { window.location.reload(); }, 180000);
    </script>
</body>
</html>
