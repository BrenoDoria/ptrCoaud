<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COAUD - CONTROLE DE EQUIPAMENTOS</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4CAF50;
            --primary-dark: #45a049;
            --secondary-color: #2196F3;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --gray-light: #f2f2f2;
            --gray-border: #ddd;
            --text-primary: #333;
            --text-secondary: #666;
            --padding-sm: 8px;
            --padding-md: 12px;
            --padding-lg: 16px;
            --border-radius: 6px;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--padding-lg);
        }

        h1 {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--primary-color);
            word-wrap: break-word;
        }

        h2 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        /* Login Section */
        #login-section {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Progress Container */
        .progress-container {
            display: none;
            text-align: center;
            padding: 1rem;
            background: #e3f2fd;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #progressText {
            font-size: 0.95rem;
            color: #1976d2;
            margin: 0;
        }

        /* Buttons */
        button {
            padding: var(--padding-md) var(--padding-lg);
            margin: var(--padding-md) var(--padding-sm);
            cursor: pointer;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            touch-action: manipulation;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: #999;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #777;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #da190b;
        }

        /* Form Sections */
        #retirada-section {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }

        #form-title {
            color: var(--primary-color);
        }

        /* Form Groups */
        .form-group {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
            grid-template-columns: 1fr;
        }

        .form-row {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr 1fr;
        }

        .form-item {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: var(--padding-sm);
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        input[type="text"],
        select {
            padding: var(--padding-md);
            border: 1px solid var(--gray-border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: inherit;
            background-color: white;
            transition: border-color 0.3s ease;
            min-height: 44px;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        input[type="text"]::placeholder {
            color: var(--text-secondary);
        }

        /* Autocomplete */
        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-border);
            border-top: none;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .autocomplete-item {
            padding: var(--padding-md);
            cursor: pointer;
            border-bottom: 1px solid var(--gray-border);
            transition: background-color 0.2s ease;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: var(--gray-light);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* Action Buttons */
        #action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--padding-md);
            margin-top: 1.5rem;
            justify-content: center;
        }

        #limparNRPsBtn {
            display: none;
        }

        /* Navigation Buttons */
        #navegacao-fichas {
            display: none;
            flex-wrap: wrap;
            gap: var(--padding-md);
            margin-bottom: 1.5rem;
            justify-content: center;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--padding-md);
            margin: 1rem 0;
            justify-content: center;
        }

        /* Table */
        .table-wrapper {
            margin-top: 2rem;
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }

        th,
        td {
            padding: var(--padding-md);
            text-align: center;
            border: 1px solid var(--gray-border);
            word-wrap: break-word;
        }

        th {
            font-weight: 600;
            font-size: 0.95rem;
        }

        td {
            font-size: 0.9rem;
        }

        tr:nth-child(even) {
            background-color: var(--gray-light);
        }

        tr:hover {
            background-color: #fffde7;
        }

        .equipamentos-cell {
            text-align: left;
            max-width: 300px;
        }

        .equipamento-item {
            padding: var(--padding-sm) 0;
            border-bottom: 1px solid var(--gray-border);
        }

        .equipamento-item:last-child {
            border-bottom: none;
        }

        .table-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--padding-sm);
            justify-content: center;
        }

        .table-actions button {
            padding: var(--padding-sm) var(--padding-md);
            font-size: 0.85rem;
            margin: 0;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-border);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            html {
                font-size: 14px;
            }

            .container {
                padding: var(--padding-md);
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .table-wrapper {
                font-size: 0.85rem;
            }

            th,
            td {
                padding: var(--padding-sm);
            }

            .equipamentos-cell {
                max-width: 200px;
            }

            button {
                padding: var(--padding-sm) var(--padding-md);
                font-size: 0.9rem;
                min-height: 40px;
            }

            .table-actions {
                gap: 2px;
            }

            .table-actions button {
                padding: 4px 8px;
                font-size: 0.75rem;
            }

            #action-buttons {
                flex-direction: column;
            }

            #action-buttons button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            html {
                font-size: 13px;
            }

            .container {
                padding: var(--padding-sm);
            }

            h1 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            h2 {
                font-size: 1rem;
            }

            th,
            td {
                padding: 4px;
                font-size: 0.75rem;
            }

            th {
                white-space: nowrap;
            }

            .equipamentos-cell {
                max-width: 150px;
            }

            .equipamento-item {
                padding: 4px 0;
                font-size: 0.75rem;
            }

            button {
                padding: 6px 10px;
                font-size: 0.8rem;
                min-height: 36px;
                margin: 2px;
            }

            .table-actions button {
                padding: 4px 6px;
                font-size: 0.7rem;
            }

            label {
                font-size: 0.9rem;
            }

            input[type="text"],
            select {
                padding: 8px;
                font-size: 16px;
            }
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .mt-1 {
            margin-top: 1rem;
        }

        .mb-1 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>COAUD - CONTROLE DE EQUIPAMENTOS</h1>

        <div id="login-section">
            <button class="btn-primary" onclick="solicitarToken()">Fazer Login com Google</button>
        </div>

        <div class="progress-container" id="progress-container">
            <div id="spinner" class="spinner"></div>
            <p id="progressText">Aguardando autenticação...</p>
        </div>

        <div id="retirada-section">
            <h2 id="form-title">Registrar Retirada de Equipamento</h2>

            <div class="form-group">
                <div class="form-row">
                    <div class="form-item">
                        <label for="operador1Input">Operador *</label>
                        <div class="autocomplete-wrapper">
                            <input 
                                type="text" 
                                id="operador1Input" 
                                placeholder="Digite as letras iniciais do nome" 
                                autocomplete="off"
                            >
                            <div id="autocompleteList" class="autocomplete-list"></div>
                        </div>
                    </div>
                    <div class="form-item">
                        <label for="operador2Select">Almoxarifado *</label>
                        <select id="operador2Select" required>
                            <option value=""></option>
                            <option value="Afonso Viana de Mesquita Filho">Afonso Viana de Mesquita Filho</option>
                            <option value="Altamir Araújo da Silva">Altamir Araújo da Silva</option>
                            <option value="Antonio Batista Ângelo">Antonio Batista Ângelo</option>
                            <option value="Waleria Bastos Cardoso">Waleria Bastos Cardoso</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-row">
                    <div class="form-item">
                        <label for="localMontagemInput">Local *</label>
                        <input 
                            type="text" 
                            id="localMontagemInput" 
                            placeholder="Ex.: Sala 101"
                        >
                    </div>
                    <div class="form-item">
                        <label for="eventoInput">Evento/Reunião *</label>
                        <input 
                            type="text" 
                            id="eventoInput" 
                            placeholder="Ex.: Reunião Mensal"
                        >
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-item">
                    <label for="nrpInput">Patrimônio (NRP) *</label>
                    <input 
                        type="text" 
                        id="nrpInput" 
                        placeholder="Digite ou bipar o NRP e pressione Enter" 
                        onkeypress="if(event.key === 'Enter') adicionarNRP()"
                    >
                </div>
            </div>

            <div id="action-buttons" class="text-center">
                <button id="limparNRPsBtn" class="btn-danger" onclick="limparNRPs()">Limpar Lista</button>
                <button id="submitButton" class="btn-primary" onclick="registrarRetirada()">Registrar Retirada</button>
                <button id="cancelButton" class="btn-secondary" onclick="cancelarEdicao()" style="display: none;">Cancelar Edição</button>
            </div>

            <div class="table-wrapper">
                <table id="patrimonioTable">
                    <thead>
                        <tr>
                            <th>NRP</th>
                            <th>Material</th>
                            <th>Localização</th>
                            <th>Responsável</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="patrimonioList"></tbody>
                </table>
            </div>
        </div>

        <div id="navegacao-fichas" class="nav-buttons">
            <button id="fichasPendentesBtn" class="btn-primary" onclick="navigateTo('fichas.html')">Fichas Pendentes</button>
            <button id="fichasArquivadasBtn" class="btn-primary" onclick="navigateTo('fichas-arquivadas.html')">Fichas Arquivadas</button>
            <button id="backButton" class="btn-secondary" onclick="navigateTo('index.html')">Voltar</button>
        </div>
    </div>

    <footer class="author-signature">© 2025 BrenoDoria</footer>

    <script>
        // Configurações
        const usuarios = {
            "supervisor": { senha: "12345", permissao: "Supervisor" },
            "operador": { senha: "12345", permissao: "Operador" }
        };

        const CLIENT_ID = '286050228811-cv6vsd075480anb1i6auuc421enuaf8q.apps.googleusercontent.com';
        const FILE_ID = '1q9RCwJ4P--QIH4kkMszffrN8ZwzkSsNoZtPH-Usk4Zw';
        const ESCALA_SHEET_ID = '1smzyrRUnPZkfZGY-8EPDGg7Js8_6-nQ2xlpXgl8Orjw';
        const API_KEY = 'AIzaSyA8yWyDVkekhaVdxCO7BuP3pjjjKTD-cDE';

        // Variáveis globais
        let tokenClient;
        let accessToken = null;
        let patrimonioData = [];
        let patrimoniosSelecionados = [];
        let fichaEditando = null;
        let escalaData = [];
        let currentFocus = -1;

        // Lista de operadores
        const operadoresList = [
            "Adson Miranda dos Anjos",
            "Afonso Viana de Mesquita Filho",
            "Alberto Cesar Souza Almeida",
            "Alexander Rafael Carvalho Paim",
            "Alison Silva de Oliveira",
            "Allan Cosseti Ardisson",
            "Altamir Araujo da Silva",
            "Antonio Batista Ângelo",
            "Antonio Rodrigues Siqueira Filho",
            "Arley Carvalho Alves",
            "Breno Doria Felicio",
            "Bruno Fernandes Braga",
            "Bruno Rodrigues do Prado",
            "Bruno Vieira Rodrigues",
            "Carlos Cesar José da Silva",
            "Carlos Eduardo Guedes da Silva",
            "Carlos Roberto de Paiva Miranda dos Santos",
            "Cinthia Neves Carvalho Barbosa",
            "Cláudio Marcelo do Nascimento",
            "Davi Aragão de Paula Gonçalves",
            "Douglas Batista da Silva",
            "Emmanuel do Amaral Idelfonso",
            "Emanuel Silveira Costa",
            "Eric Samuel do Ouro",
            "Erika Fedosseeff Auler",
            "Eromilson Monteiro Dutra Chaves",
            "Evellyn Mendes de Souza Nunes",
            "Felipe Omena Vasconcellos de Assis",
            "Fernando de Sousa Vasconcelos",
            "Flávio Lima Câmara",
            "Francisco de Assis da Silva Sales",
            "Francisco de Sousa Filho",
            "Francisco Juniel Sousa e Silva",
            "Geraldo Ribeiro de Souza Filho",
            "Gildo Marques da Silva",
            "Gilson Gomes da Silva",
            "Gleisson Carlos Pereira da Silva",
            "Guilherme Malheiro da Rocha Pinto",
            "Helisson Rafael de O. Leite",
            "Helyeber Feitosa Ferreira",
            "Huelisson Amancio de Moraes Silva",
            "Igor Mendes dos Santos",
            "Isaias Pereira Soares",
            "Joel Luiz de Sá Silva",
            "Joel Pereira Santos",
            "Jônatas Soares de Andrade",
            "Jose Henrique Ferreira da Silva",
            "Jose Leandro Marques",
            "José Nilton Abraão de Sousa",
            "Josue Cardoso Abreu",
            "Joval Bastos Freitas Júnior",
            "Juliano Gustavo Pedro de Oliveira",
            "Kely Berlinck Freire",
            "Kleber de Araújo Moura",
            "Leandro Calixto da Silva",
            "Leandro Silva Lima Alves",
            "Leonardo Augusto de Freitas",
            "Letícia Santana Araújo",
            "Lívia Maria de Souza",
            "Lucas Lima Lira",
            "Lucas Ribeiro dos Santos",
            "Luciano de Freitas Silva",
            "Luiz Henrique Reis de Lima",
            "Marcelo Gomes da Silva",
            "Marco Antonio Baldresca Lambert de Brito",
            "Marco Antônio Felício Júnior",
            "Marcos Borges de Souza",
            "Marcus Aurélius Fernandes de Moura",
            "Massilon Alves de Sousa Filho",
            "Mateus da Silva Lima",
            "Matheus Gabriel Damasceno Dias",
            "Matheus Henrique Felix Barbosa",
            "Múcio Homero Rocha Pires de Oliveira",
            "Orlando Villavicencio Venegas",
            "Otoniel Alves de Souza",
            "Paulo Fernando Volpe",
            "Paulo Roberto Pereira",
            "Paulo Soares da Costa",
            "Pedro Henrique Candido Boaventura",
            "Péricles Cruz da Silva",
            "Rafael Queiroz Lemos de Oliveira",
            "Reynaldo Jessé Rodrigues da Silva",
            "Richard Rodrigues dos Santos",
            "Roberio Antunes Simionato",
            "Rondney Rodrigues Alves Sousa",
            "Rosivan Augustinho Pereira",
            "Thiago Veríssimo Cabral Freitas",
            "Waleria Bastos Cardoso",
            "Wellington Jorge Souza Mendes",
            "Wendel Vieira da Costa",
            "Wesley Maurício Ribeiro França",
            "Willian Neves da Silva",
            "Wirlem Silva Alves"
        ];

        const patrimoniosPermitidosParaRepeticao = [
            "99010001","99010002","99010003","99010004","99010005","99010006","99010007","99010008","99010009","99010010",
            "99010011","99010012","99010013","99010014","99010015","99010016","99010017","99010018","99010019","99010020",
            "99010021","99010022","99010023","99010024","99010025","99030001","99030002","99040001","99020001","99020002",
            "99020003","99020004","99040002","99040003","99030003","99030004","99030005","99030006","99040004","99030011"
        ];

        // Inicialização
        window.onload = () => {
            const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
            if (!usuarioLogado || !usuarios[usuarioLogado.username]) {
                alert("Usuário não está logado. Faça login novamente.");
                window.location.href = "index.html";
                return;
            }

            if (usuarios[usuarioLogado.username].permissao !== "Supervisor") {
                alert("Acesso negado: Você não tem permissão para acessar o Controle de Almoxarifado.");
                window.location.href = "index.html";
                return;
            }

            inicializarTokenClient();
            configurarAutocomplete();
            carregarFichaParaEditar();
        };

        function inicializarTokenClient() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: handleTokenResponse
            });

            const savedToken = localStorage.getItem("access_token");
            if (savedToken) {
                accessToken = savedToken;
                mostrarSecaoRetirada();
            } else {
                mostrarSecaoLogin();
            }
        }

        function handleTokenResponse(tokenResponse) {
            if (tokenResponse.error) {
                document.getElementById("progressText").textContent = "Erro ao autenticar: " + tokenResponse.error;
                return;
            }
            accessToken = tokenResponse.access_token;
            localStorage.setItem("access_token", accessToken);
            mostrarSecaoRetirada();
        }

        function mostrarSecaoLogin() {
            document.getElementById("login-section").style.display = "block";
            document.getElementById("retirada-section").style.display = "none";
            document.getElementById("navegacao-fichas").style.display = "none";
            document.getElementById("progress-container").style.display = "none";
        }

        function mostrarSecaoRetirada() {
            document.getElementById("login-section").style.display = "none";
            document.getElementById("retirada-section").style.display = "block";
            document.getElementById("navegacao-fichas").style.display = "flex";
            document.getElementById("progress-container").style.display = "block";
            document.getElementById("progressText").textContent = "Carregando dados...";
            
            carregarPatrimoniosDoSheets();
            carregarEscala();
        }

        function solicitarToken() {
            tokenClient.requestAccessToken();
        }

        // Autocomplete
        function configurarAutocomplete() {
            const input = document.getElementById("operador1Input");
            input.addEventListener("input", filtrarOperadores);
            input.addEventListener("keydown", navegarComTeclado);
            input.addEventListener("focus", () => { if (input.value.trim()) filtrarOperadores(); });
            document.addEventListener("click", (e) => {
                if (!input.contains(e.target) && !document.getElementById("autocompleteList").contains(e.target)) {
                    document.getElementById("autocompleteList").style.display = "none";
                }
            });
        }

        function filtrarOperadores() {
            const input = document.getElementById("operador1Input");
            const filter = input.value.toLowerCase().trim();
            const list = document.getElementById("autocompleteList");
            list.innerHTML = "";
            currentFocus = -1;

            if (!filter) {
                list.style.display = "none";
                return;
            }

            const matches = operadoresList.filter(nome => {
                const palavras = nome.toLowerCase().split(" ");
                return palavras.some(palavra => palavra.startsWith(filter));
            });

            if (matches.length === 0) {
                list.innerHTML = '<div class="autocomplete-item" style="color:#999;">Nenhum operador encontrado</div>';
                list.style.display = "block";
                return;
            }

            matches.forEach((nome) => {
                const item = document.createElement("div");
                item.classList.add("autocomplete-item");
                item.textContent = nome;
                item.onclick = () => selecionarOperador(nome);
                list.appendChild(item);
            });

            list.style.display = "block";
        }

        function navegarComTeclado(e) {
            const list = document.getElementById("autocompleteList");
            const items = list.getElementsByClassName("autocomplete-item");

            if (e.key === "ArrowDown") {
                e.preventDefault();
                currentFocus = (currentFocus + 1) % items.length;
                atualizarSelecaoVisual(items);
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                currentFocus = (currentFocus - 1 + items.length) % items.length;
                atualizarSelecaoVisual(items);
            } else if (e.key === "Enter") {
                e.preventDefault();
                if (currentFocus > -1 && items[currentFocus]) {
                    items[currentFocus].click();
                }
            }
        }

        function atualizarSelecaoVisual(items) {
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove("selected");
            }
            if (currentFocus > -1 && items[currentFocus]) {
                items[currentFocus].classList.add("selected");
                items[currentFocus].scrollIntoView({ block: "nearest" });
            }
        }

        function selecionarOperador(nome) {
            document.getElementById("operador1Input").value = nome;
            document.getElementById("autocompleteList").style.display = "none";
            buscarOperadorNaEscala(nome);
            atualizarOperador2();
        }

        function buscarOperadorNaEscala(nomeSelecionado) {
            if (!nomeSelecionado) {
                limparCamposOperador();
                return;
            }

            let linhaOperador = null;
            for (let i = 1; i < escalaData.length; i++) {
                const row = escalaData[i];
                if (row[9]) {
                    const nomeNaEscala = normalizarNome(row[9].trim());
                    const nomeDigitado = normalizarNome(nomeSelecionado);
                    if (nomeNaEscala === nomeDigitado) {
                        linhaOperador = row;
                        break;
                    }
                }
            }

            if (linhaOperador) {
                document.getElementById("localMontagemInput").value = linhaOperador[2]?.trim() || "";
                document.getElementById("eventoInput").value = linhaOperador[6]?.trim() || "";
                document.getElementById("progressText").textContent = `Operador ${nomeSelecionado} encontrado na escala.`;
            } else {
                limparCamposOperador();
                document.getElementById("progressText").textContent = `Operador ${nomeSelecionado} não encontrado na escala. Digite manualmente.`;
            }
        }

        function limparCamposOperador() {
            document.getElementById("localMontagemInput").value = "";
            document.getElementById("eventoInput").value = "";
        }

        function normalizarNome(nome) {
            return nome.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function atualizarOperador2() {
            const operador1 = document.getElementById("operador1Input").value;
            const select = document.getElementById("operador2Select");
            const current = select.value;
            
            select.innerHTML = `
                <option value=""></option>
                <option value="Afonso Viana de Mesquita Filho" ${operador1 === "Afonso Viana de Mesquita Filho" ? "disabled" : ""}>Afonso Viana de Mesquita Filho</option>
                <option value="Altamir Araújo da Silva" ${operador1 === "Altamir Araújo da Silva" ? "disabled" : ""}>Altamir Araújo da Silva</option>
                <option value="Antonio Batista Ângelo" ${operador1 === "Antonio Batista Ângelo" ? "disabled" : ""}>Antonio Batista Ângelo</option>
                <option value="Waleria Bastos Cardoso" ${operador1 === "Waleria Bastos Cardoso" ? "disabled" : ""}>Waleria Bastos Cardoso</option>
            `;
            select.value = (operador1 === current) ? "" : current;
        }

        // Carregamento de dados
        function carregarPatrimoniosDoSheets(retryCount = 0) {
            const maxRetries = 3;
            document.getElementById("spinner").style.display = "inline-block";
            document.getElementById("progressText").textContent = "Consultando Servidor...";

            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/SIGMAS!A:D`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            })
            .then(async response => {
                if (!response.ok) {
                    if (response.status === 401 && retryCount < maxRetries) {
                        localStorage.removeItem("access_token");
                        accessToken = null;
                        mostrarSecaoLogin();
                        solicitarToken();
                        return;
                    }
                    const err = await response.json();
                    throw new Error(err.error?.message || response.statusText);
                }
                return response.json();
            })
            .then(data => {
                patrimonioData = data.values || [];
               document.getElementById("progressText").textContent = "Dados carregados com sucesso!";
                document.getElementById("spinner").style.display = "none";
            })
            .catch(err => {
                console.error(err);
                document.getElementById("progressText").textContent = "Erro: " + err.message;
                document.getElementById("spinner").style.display = "none";
            });
        }

        function carregarEscala() {
            document.getElementById("progressText").textContent = "Carregando escala de eventos...";
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${ESCALA_SHEET_ID}/values/escalaAudio!A:Z?key=${API_KEY}`)
            .then(r => r.ok ? r.json() : Promise.reject("Erro na escala"))
            .then(data => {
                escalaData = data.values || [];
                document.getElementById("progressText").textContent = "Escala carregada com sucesso!";
            })
            .catch(err => {
                console.error(err);
                document.getElementById("progressText").textContent = "Erro ao carregar escala.";
            });
        }

        // NRP
        function adicionarNRP() {
            let nrp = document.getElementById("nrpInput").value.trim().replace(/\./g, "");
            if (!nrp) return;

            const nrpSemZeros = nrp.replace(/^0+/, "");

            // Verifica duplicação (se não é permitido repetir)
            if (!patrimoniosPermitidosParaRepeticao.includes(nrpSemZeros)) {
                if (patrimoniosSelecionados.some(p => p.NRP.replace(/^0+/, "") === nrpSemZeros)) {
                    document.getElementById("progressText").textContent = `NRP "${nrp}" já adicionado.`;
                    document.getElementById("nrpInput").value = "";
                    return;
                }
            }

            // Busca no banco de dados
            const encontrado = patrimonioData.find(row => row[0]?.toString().replace(/^0+/, "") === nrpSemZeros);
            if (encontrado) {
                patrimoniosSelecionados.push({
                    NRP: encontrado[0],
                    Material: encontrado[1],
                    Localização: encontrado[2] || "N/A",
                    Responsável: encontrado[3] || "N/A"
                });
                atualizarListaPatrimonios();
                document.getElementById("progressText").textContent = `NRP "${nrp}" adicionado com sucesso!`;
            } else {
                document.getElementById("progressText").textContent = `NRP "${nrp}" não encontrado no sistema.`;
            }

            document.getElementById("nrpInput").value = "";
            document.getElementById("limparNRPsBtn").style.display = patrimoniosSelecionados.length > 0 ? "inline-block" : "none";
        }

        function atualizarListaPatrimonios() {
            const tbody = document.getElementById("patrimonioList");
            tbody.innerHTML = "";
            patrimoniosSelecionados.forEach((item, i) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.NRP}</td>
                    <td>${item.Material}</td>
                    <td>${item.Localização}</td>
                    <td>${item.Responsável}</td>
                    <td><button class="btn-danger" onclick="removerPatrimonio(${i})">Remover</button></td>
                `;
                tbody.prepend(tr);
            });
        }

        function removerPatrimonio(i) {
            patrimoniosSelecionados.splice(i, 1);
            atualizarListaPatrimonios();
            document.getElementById("limparNRPsBtn").style.display = patrimoniosSelecionados.length > 0 ? "inline-block" : "none";
        }

        function limparNRPs() {
            patrimoniosSelecionados = [];
            atualizarListaPatrimonios();
            document.getElementById("limparNRPsBtn").style.display = "none";
        }

        // Ficha para editar
        function carregarFichaParaEditar() {
            const fichaParaEditar = JSON.parse(localStorage.getItem('fichaParaEditar'));
            if (!fichaParaEditar) return;

            fichaEditando = fichaParaEditar;
            document.getElementById("form-title").textContent = "Editar Ficha Pendente";
            document.getElementById("submitButton").textContent = "Salvar Alterações";
            document.getElementById("cancelButton").style.display = "inline-block";

            document.getElementById("operador1Input").value = fichaEditando.operador1;
            document.getElementById("operador2Select").value = fichaEditando.operador2;
            document.getElementById("localMontagemInput").value = fichaEditando.local;
            document.getElementById("eventoInput").value = fichaEditando.evento;

            // Reconstruir equipamentos com dados completos do SIGMAS
            patrimoniosSelecionados = fichaEditando.equipamentos.map(equip => {
                const [nrp, ...materialParts] = equip.split(' - ');
                const nrpSemZeros = nrp.trim().replace(/^0+/, "");
                const encontrado = patrimonioData.find(row => row[0]?.toString().replace(/^0+/, "") === nrpSemZeros);
                
                return {
                    NRP: encontrado ? encontrado[0] : nrp.trim(),
                    Material: encontrado ? encontrado[1] : materialParts.join(' - '),
                    Localização: encontrado ? (encontrado[2] || "N/A") : "N/A",
                    Responsável: encontrado ? (encontrado[3] || "N/A") : "N/A"
                };
            });

            atualizarListaPatrimonios();
            document.getElementById("limparNRPsBtn").style.display = patrimoniosSelecionados.length > 0 ? "inline-block" : "none";
            toggleBotoesNavegacao(true);
            atualizarOperador2();
        }

        function toggleBotoesNavegacao(disable) {
            document.getElementById("fichasPendentesBtn").disabled = disable;
            document.getElementById("fichasArquivadasBtn").disabled = disable;
            document.getElementById("backButton").disabled = disable;
        }

        function navigateTo(page) {
            if (fichaEditando) {
                document.getElementById("progressText").textContent = "Salve as alterações antes de navegar.";
                return;
            }
            window.location.href = page;
        }

        function cancelarEdicao() {
            fichaEditando = null;
            localStorage.removeItem('fichaParaEditar');
            toggleBotoesNavegacao(false);
            document.getElementById("form-title").textContent = "Registrar Retirada de Equipamento";
            document.getElementById("submitButton").textContent = "Registrar Retirada";
            document.getElementById("cancelButton").style.display = "none";
            document.getElementById("operador1Input").value = "";
            document.getElementById("operador2Select").value = "";
            document.getElementById("localMontagemInput").value = "";
            document.getElementById("eventoInput").value = "";
            patrimoniosSelecionados = [];
            atualizarListaPatrimonios();
            document.getElementById("limparNRPsBtn").style.display = "none";
            document.getElementById("autocompleteList").style.display = "none";
            atualizarOperador2();
        }

        // Registrar Retirada
        async function registrarRetirada() {
            const operador1 = document.getElementById("operador1Input").value.trim();
            const operador2 = document.getElementById("operador2Select").value;
            const localMontagem = document.getElementById("localMontagemInput").value.trim();
            const evento = document.getElementById("eventoInput").value.trim();
            const dataRetirada = fichaEditando ? fichaEditando.dataRetirada : new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });

            if (!operador1 || patrimoniosSelecionados.length === 0 || !localMontagem || !evento) {
                document.getElementById("progressText").textContent = "Preencha todos os campos obrigatórios.";
                return;
            }

            const equipamentos = patrimoniosSelecionados.map(i => `${i.NRP} - ${i.Material}`).join("; ");
            const novaLinha = [fichaEditando ? fichaEditando.idFicha : Date.now().toString(), operador1, operador2, equipamentos, localMontagem, evento, dataRetirada];

            document.getElementById("spinner").style.display = "inline-block";
            document.getElementById("progressText").textContent = fichaEditando ? "Salvando alterações..." : "Registrando retirada...";

            try {
                // Verifica conflito de NRP
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/RETIRADAS_PENDENTES!A:G`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.values && data.values.length > 1) {
                        const usados = [];
                        data.values.slice(1).forEach((row, idx) => {
                            if (fichaEditando && (idx + 1) === fichaEditando.rowIndex) return;
                            const eqs = row[3]?.split("; ") || [];
                            eqs.forEach(e => {
                                const nrp = e.split(" - ")[0]?.replace(/^0+/, "");
                                if (nrp) usados.push(nrp);
                            });
                        });

                        const conflito = patrimoniosSelecionados.find(p => {
                            const n = p.NRP.replace(/^0+/, "");
                            return usados.includes(n) && !patrimoniosPermitidosParaRepeticao.includes(n);
                        });

                        if (conflito) {
                            alert(`O patrimônio ${conflito.NRP} já está em uso em outra ficha pendente.`);
                            document.getElementById("spinner").style.display = "none";
                            return;
                        }
                    }
                }

                if (fichaEditando) {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/RETIRADAS_PENDENTES!A${fichaEditando.rowIndex + 1}:G${fichaEditando.rowIndex + 1}?valueInputOption=RAW`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [novaLinha] })
                    });
                    localStorage.removeItem('fichaParaEditar');
                    document.getElementById("progressText").textContent = "Ficha atualizada com sucesso!";
                } else {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/RETIRADAS_PENDENTES!A:G:append?valueInputOption=RAW`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [novaLinha] })
                    });
                    document.getElementById("progressText").textContent = "Retirada registrada com sucesso!";
                }

                // Limpar formulário
                document.getElementById("operador1Input").value = "";
                document.getElementById("operador2Select").value = "";
                document.getElementById("localMontagemInput").value = "";
                document.getElementById("eventoInput").value = "";
                patrimoniosSelecionados = [];
                atualizarListaPatrimonios();
                document.getElementById("limparNRPsBtn").style.display = "none";
                document.getElementById("form-title").textContent = "Registrar Retirada de Equipamento";
                document.getElementById("submitButton").textContent = "Registrar Retirada";
                document.getElementById("cancelButton").style.display = "none";
                fichaEditando = null;
                toggleBotoesNavegacao(false);
                document.getElementById("spinner").style.display = "none";

            } catch (err) {
                document.getElementById("progressText").textContent = "Erro: " + err.message;
                document.getElementById("spinner").style.display = "none";
            }
        }

        // Auto-reload a cada 3 minutos
        /*setInterval(() => {
            if (!fichaEditando) {
                location.reload();
            }
        }, 180000);*/
    </script>
</body>
</html>
