<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizador de Patrimônios SIGMAS</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        #editor-section {
            display: none;
            margin-top: 20px;
        }
        #local-editor, #responsavel-editor {
            display: none;
        }
        #responsavel-list {
            list-style-type: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        #responsavel-list li {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #ccc;
        }
        #responsavel-list li:hover {
            background-color: #eee;
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            table {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PATRIMÔNIOS SIGMAS - LOCALIZADOR</h1>
        <div id="login-section">
            <button onclick="solicitarToken()">Fazer Login com Google</button>
        </div>
        <div class="progress-container" id="progress-container" style="display: none;">
            <div id="spinner" class="spinner"></div>
            <p id="progressText">Consultando Servidor</p>
        </div>
        <div id="busca-section" style="display: none;">
            <input type="text" id="patrimonioInput" placeholder="Digite o Número do Patrimônio" autofocus>
            <button onclick="buscarPatrimonio()">Buscar Localização</button>
        </div>
        <table id="patrimonioTable" style="display: none;">
            <thead>
                <tr>
                    <th>NRP</th>
                    <th>Material</th>
                    <th>Localização</th>
                    <th>Responsável</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="patrimonioList"></tbody>
        </table>
        <div id="editor-section">
            <div id="local-editor">
                <h3>Alterar Local</h3>
                <input type="text" id="novoLocalInput" placeholder="Digite o novo local">
                <button onclick="confirmarNovoLocal()">Confirmar</button>
                <button onclick="cancelarEdicao()">Cancelar</button>
            </div>
            <div id="responsavel-editor">
                <h3>Alterar Responsável</h3>
                <input type="text" id="responsavelSearch" placeholder="Digite pelo menos 3 letras para buscar" oninput="filterResponsaveis()">
                <ul id="responsavel-list"></ul>
                <button onclick="cancelarEdicao()">Cancelar</button>
            </div>
        </div>
        <button class="backButton" onclick="window.location.href='index.html'">Voltar</button>
    </div>
    <footer class="author-signature">© 2025 BrenoDoria</footer>
    <script>
        // Usuários e permissões
        const usuarios = {
            "supervisor": { senha: "12345", permissao: "Supervisor" },
            "operador": { senha: "12345", permissao: "Operador" }
        };
        // Verificação de permissão ao carregar a página
        window.onload = async () => {
            const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
            if (!usuarioLogado || !usuarios[usuarioLogado.username]) {
                alert("Usuário não está logado. Faça login novamente.");
                window.location.href = "index.html";
                return;
            }
      
            // Verifica se o usuário tem permissão para acessar o Comparador
            if (usuarios[usuarioLogado.username].permissao !== "Supervisor") {
                alert("Acesso negado: Você não tem permissão para acessar o Localizador de Patrimônios.");
                window.location.href = "index.html";
                return;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email',
                callback: (tokenResponse) => {
                    if (tokenResponse.error) {
                        document.getElementById("progressText").textContent = "Erro ao autenticar: " + tokenResponse.error;
                        document.getElementById("progress-container").style.display = "block";
                        return;
                    }
                    accessToken = tokenResponse.access_token;
                    localStorage.setItem("access_token", accessToken);
                    loadUserEmail().then(() => {
                        document.getElementById("progressText").textContent = "Autenticado com sucesso! Carregando dados...";
                        document.getElementById("progress-container").style.display = "block";
                        document.getElementById("login-section").style.display = "none";
                        document.getElementById("busca-section").style.display = "block";
                        carregarPatrimoniosDoSheets();
                    });
                }
            });
            const savedToken = localStorage.getItem("access_token");
            if (savedToken) {
                accessToken = savedToken;
                await loadUserEmail();
                if (!userEmail) {
                    localStorage.removeItem("access_token");
                    document.getElementById("login-section").style.display = "block";
                    document.getElementById("busca-section").style.display = "none";
                    document.getElementById("progress-container").style.display = "none";
                    alert("Por favor, faça login novamente para acessar as informações necessárias.");
                    return;
                }
                document.getElementById("login-section").style.display = "none";
                document.getElementById("busca-section").style.display = "block";
                document.getElementById("progress-container").style.display = "block";
                document.getElementById("progressText").textContent = "Usando token salvo. Carregando dados...";
                carregarPatrimoniosDoSheets();
            }
            // Adiciona listener para a tecla Enter no campo de patrimônio
            document.getElementById("patrimonioInput").addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    buscarPatrimonio();
                }
            });
        };
        const CLIENT_ID = '286050228811-cv6vsd075480anb1i6auuc421enuaf8q.apps.googleusercontent.com';
        const FILE_ID = '1iNeSf0wakQ6j9Eg_qOCzVNKcIVVIsukeThL0Phpd5LE';
        let tokenClient;
        let accessToken = null;
        let userEmail = null;
        let dadosPlanilha = null;
        let responsaveisUnicos = new Set();
        let sheetIdSigmas = null;
        let sheetIdCoaud = null;
        let currentRowIndex = null;
        let currentNrp = null;
        let currentEditor = null;
        function solicitarToken() {
            tokenClient.requestAccessToken();
        }
        async function loadUserEmail() {
            try {
                const response = await fetch('https://www.googleapis.com/userinfo/v2/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }
                const data = await response.json();
                userEmail = data.email;
            } catch (error) {
                console.error("Erro ao carregar email do usuário:", error);
                userEmail = null;
            }
        }
        function refreshResponsaveis() {
            responsaveisUnicos = new Set(dadosPlanilha.slice(1).map(row => row[3] ? row[3].trim() : '').filter(t => t));
        }
        function getLog(type) {
            if (!userEmail) {
                alert("Email do usuário não disponível.");
                return "";
            }
            const now = new Date();
            const date = now.toLocaleDateString('pt-BR');
            const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            return `alterado: "${type}" data: ${date} hora: ${time}hs pelo operador: ${userEmail}`;
        }
        function carregarPatrimoniosDoSheets(retryCount = 0) {
            const maxRetries = 3;
            document.getElementById("spinner").style.display = "inline-block";
            document.getElementById("progressText").textContent = "Consultando Servidor";
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/SIGMAS!A:E`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(async response => {
                if (!response.ok) {
                    if (response.status === 401 && retryCount < maxRetries) {
                        document.getElementById("progressText").textContent = "Token expirado, reautenticando...";
                        localStorage.removeItem("access_token");
                        document.getElementById("login-section").style.display = "block";
                        document.getElementById("busca-section").style.display = "none";
                        document.getElementById("progress-container").style.display = "none";
                        solicitarToken();
                        return;
                    } else if (response.status === 429 && retryCount < maxRetries) {
                        document.getElementById("progressText").textContent = `Limite de taxa atingido, tentando novamente (${retryCount + 1}/${maxRetries})...`;
                        setTimeout(() => carregarPatrimoniosDoSheets(retryCount + 1), 2000 * (retryCount + 1));
                        return;
                    } else if (response.status === 400) {
                        const errorData = await response.json();
                        throw new Error(`Erro HTTP ${response.status}: ${errorData.error?.message || "Intervalo inválido. Verifique se a aba SIGMAS contém dados em A:E."}`);
                    }
                    const errorData = await response.json();
                    throw new Error(`Erro HTTP ${response.status}: ${errorData.error?.message || response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                dadosPlanilha = data.values || [];
                refreshResponsaveis();
                return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
            })
            .then(async response => {
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro ao carregar metadados: ${errorData.error?.message || response.statusText}`);
                }
                return response.json();
            })
            .then(meta => {
                meta.sheets.forEach(sheet => {
                    if (sheet.properties.title === 'SIGMAS') {
                        sheetIdSigmas = sheet.properties.sheetId;
                    } else if (sheet.properties.title === 'COAUD') {
                        sheetIdCoaud = sheet.properties.sheetId;
                    }
                });
                if (!sheetIdSigmas || !sheetIdCoaud) {
                    throw new Error('Abas SIGMAS ou COAUD não encontradas.');
                }
                document.getElementById("progressText").textContent = "AUTORIZADA CONSULTA";
                document.getElementById("spinner").style.display = "none";
                document.getElementById("patrimonioTable").style.display = "table";
            })
            .catch(error => {
                console.error("Erro ao carregar dados do Sheets:", error);
                document.getElementById("progressText").textContent = "Erro ao carregar os dados: " + error.message;
                document.getElementById("spinner").style.display = "none";
                document.getElementById("patrimonioTable").style.display = "none";
            });
        }
        function buscarPatrimonio() {
            // Limpa o campo ANTES de processar a busca
            const patrimonioInput = document.getElementById("patrimonioInput");
            const nrp = patrimonioInput.value.trim();
            let cleanedNrp = nrp.replace(/\./g, "").replace(/^0+/, "");
            const listElement = document.getElementById("patrimonioList");
            const progressText = document.getElementById("progressText");
            if (!nrp) {
                progressText.textContent = "Digite o número do patrimônio (NRP) para buscar.";
                listElement.innerHTML = "";
                return;
            }
            if (!dadosPlanilha) {
                progressText.textContent = "Aguardando carregamento dos dados...";
                listElement.innerHTML = "";
                return;
            }
            const rowIndex = dadosPlanilha.findIndex(row => row[0] && row[0].toString().trim().replace(/\./g, "").replace(/^0+/, "") === cleanedNrp);
            listElement.innerHTML = "";
            if (rowIndex !== -1) {
                const patrimonio = dadosPlanilha[rowIndex];
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${patrimonio[0] || "N/A"}</td>
                    <td>${patrimonio[1] || "N/A"}</td>
                    <td id="localizacao-${rowIndex}">${patrimonio[2] || "Não especificada"}</td>
                    <td id="responsavel-${rowIndex}">${patrimonio[3] || "Não informado"}</td>
                    <td>
                        <button onclick="mostrarEditorLocal(${rowIndex}, '${nrp}')">Alterar Local</button>
                        <button onclick="mostrarEditorResponsavel(${rowIndex}, '${nrp}')">Alterar Responsável</button>
                    </td>
                `;
                listElement.appendChild(row);
                progressText.textContent = `Patrimônio ${nrp} encontrado!`;
            } else {
                progressText.textContent = `Patrimônio ${nrp} não encontrado nos dados do ano anterior.`;
            }
            // Limpa o campo após a busca e mantém o foco
            patrimonioInput.value = "";
            patrimonioInput.focus();
        }
        function mostrarEditorLocal(rowIndex, nrp) {
            currentRowIndex = rowIndex;
            currentNrp = nrp;
            currentEditor = 'local';
            document.getElementById('editor-section').style.display = 'block';
            document.getElementById('local-editor').style.display = 'block';
            document.getElementById('responsavel-editor').style.display = 'none';
            document.getElementById('novoLocalInput').value = '';
            document.getElementById('novoLocalInput').focus();
        }
        function mostrarEditorResponsavel(rowIndex, nrp) {
            currentRowIndex = rowIndex;
            currentNrp = nrp;
            currentEditor = 'responsavel';
            document.getElementById('editor-section').style.display = 'block';
            document.getElementById('local-editor').style.display = 'none';
            document.getElementById('responsavel-editor').style.display = 'block';
            document.getElementById('responsavelSearch').value = '';
            filterResponsaveis();
            document.getElementById('responsavelSearch').focus();
        }
        function cancelarEdicao() {
            document.getElementById('editor-section').style.display = 'none';
            document.getElementById('local-editor').style.display = 'none';
            document.getElementById('responsavel-editor').style.display = 'none';
        }
        function confirmarNovoLocal() {
            const novoLocal = document.getElementById('novoLocalInput').value.trim();
            if (novoLocal !== "") {
                atualizarLocal(currentRowIndex, novoLocal);
                cancelarEdicao();
            } else {
                alert('Por favor, digite um local válido.');
            }
        }
        function atualizarLocal(rowIndex, novoLocal) {
            const linha = rowIndex + 1;  // Linha 1-based para o Google Sheets
            const log = getLog('sala');
            if (!log) return;
            document.getElementById("progressText").textContent = "Atualizando planilha...";
            document.getElementById("progress-container").style.display = "block";
            document.getElementById("spinner").style.display = "inline-block";
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values:batchUpdate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    valueInputOption: 'USER_ENTERED',
                    data: [
                        {
                            range: `SIGMAS!C${linha}`,
                            values: [[novoLocal]]
                        },
                        {
                            range: `SIGMAS!E${linha}`,
                            values: [[log]]
                        }
                    ]
                })
            })
            .then(async response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        document.getElementById("progressText").textContent = "Token expirado, reautenticando...";
                        localStorage.removeItem("access_token");
                        document.getElementById("login-section").style.display = "block";
                        document.getElementById("busca-section").style.display = "none";
                        document.getElementById("progress-container").style.display = "none";
                        solicitarToken();
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(`Erro HTTP ${response.status}: ${errorData.error?.message || response.statusText}`);
                }
                return response.json();
            })
            .then(() => {
                // Atualiza localmente e na UI
                dadosPlanilha[rowIndex][2] = novoLocal;
                dadosPlanilha[rowIndex][4] = log;
                document.getElementById(`localizacao-${rowIndex}`).textContent = novoLocal;
                document.getElementById("progressText").textContent = "Local atualizado com sucesso!";
                document.getElementById("spinner").style.display = "none";
            })
            .catch(error => {
                console.error("Erro ao atualizar a planilha:", error);
                document.getElementById("progressText").textContent = "Erro ao atualizar: " + error.message;
                document.getElementById("spinner").style.display = "none";
            });
        }
        function filterResponsaveis() {
            const search = document.getElementById('responsavelSearch').value.trim().toLowerCase();
            const list = document.getElementById('responsavel-list');
            list.innerHTML = '';
            if (search.length < 3) {
                const li = document.createElement('li');
                li.textContent = 'Digite 3 ou mais letras para ver sugestões.';
                list.appendChild(li);
                return;
            }
            const filtered = Array.from(responsaveisUnicos).filter(name => name.toLowerCase().includes(search)).sort();
            if (filtered.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'Nenhum responsável encontrado.';
                list.appendChild(li);
            } else {
                filtered.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    li.onclick = () => {
                        atualizarResponsavel(currentRowIndex, name, currentNrp);
                        cancelarEdicao();
                    };
                    list.appendChild(li);
                });
            }
        }
        function atualizarResponsavel(rowIndex, novoResp, nrp) {
            document.getElementById("progressText").textContent = "Atualizando planilha...";
            document.getElementById("progress-container").style.display = "block";
            document.getElementById("spinner").style.display = "inline-block";
            const log = getLog('responsavel');
            if (!log) return;
            const isMove = novoResp === "ALBERTO CESAR SOUZA ALMEIDA (5302)" || novoResp === "PAULO FERNANDO VOLPE (5933)";
            if (isMove) {
                let rowData = [...dadosPlanilha[rowIndex]];
                rowData[3] = novoResp;
                rowData[4] = log;
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/COAUD!A1:append?valueInputOption=USER_ENTERED`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: [rowData]
                    })
                })
                .then(async response => {
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Erro ao append: ${errorData.error?.message || response.statusText}`);
                    }
                    return response.json();
                })
                .then(() => {
                    return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}:batchUpdate`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            requests: [{
                                deleteDimension: {
                                    range: {
                                        sheetId: sheetIdSigmas,
                                        dimension: 'ROWS',
                                        startIndex: rowIndex,
                                        endIndex: rowIndex + 1
                                    }
                                }
                            }]
                        })
                    });
                })
                .then(async response => {
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Erro ao delete: ${errorData.error?.message || response.statusText}`);
                    }
                    dadosPlanilha.splice(rowIndex, 1);
                    refreshResponsaveis();
                    document.getElementById("patrimonioList").innerHTML = '';
                    document.getElementById("progressText").textContent = `Patrimônio ${nrp} movido para COAUD!`;
                    document.getElementById("spinner").style.display = "none";
                })
                .catch(error => {
                    console.error("Erro ao mover patrimônio:", error);
                    document.getElementById("progressText").textContent = "Erro ao mover: " + error.message;
                    document.getElementById("spinner").style.display = "none";
                });
            } else {
                const linha = rowIndex + 1;
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values:batchUpdate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        valueInputOption: 'USER_ENTERED',
                        data: [
                            {
                                range: `SIGMAS!D${linha}`,
                                values: [[novoResp]]
                            },
                            {
                                range: `SIGMAS!E${linha}`,
                                values: [[log]]
                            }
                        ]
                    })
                })
                .then(async response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            document.getElementById("progressText").textContent = "Token expirado, reautenticando...";
                            localStorage.removeItem("access_token");
                            document.getElementById("login-section").style.display = "block";
                            document.getElementById("busca-section").style.display = "none";
                            document.getElementById("progress-container").style.display = "none";
                            solicitarToken();
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(`Erro HTTP ${response.status}: ${errorData.error?.message || response.statusText}`);
                    }
                    return response.json();
                })
                .then(() => {
                    dadosPlanilha[rowIndex][3] = novoResp;
                    dadosPlanilha[rowIndex][4] = log;
                    document.getElementById(`responsavel-${rowIndex}`).textContent = novoResp;
                    refreshResponsaveis();
                    document.getElementById("progressText").textContent = "Responsável atualizado com sucesso!";
                    document.getElementById("spinner").style.display = "none";
                })
                .catch(error => {
                    console.error("Erro ao atualizar responsável:", error);
                    document.getElementById("progressText").textContent = "Erro ao atualizar: " + error.message;
                    document.getElementById("spinner").style.display = "none";
                });
            }
        }
    </script>
</body>
</html>
