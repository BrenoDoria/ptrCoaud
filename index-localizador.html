<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizador de Patrimônios SIGMAS</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root {
            --font-size-base: 1rem;
            --padding-base: 1.25rem;
        }
        .container { text-align: center; padding: var(--padding-base); max-width: 90%; margin: 0 auto; }
        h1 { font-size: calc(var(--font-size-base) * 1.5); margin-bottom: 1rem; }
        .progress-container { margin: 1rem 0; }
        .spinner {
            display: none; border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 1.25rem; height: 1.25rem; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        button { padding: 0.5rem 1rem; margin: 0.3rem; cursor: pointer; min-height: 2.75rem; font-size: 1rem; }
        .backButton { background: #ccc; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.8rem; text-align: center; border: 1px solid #ddd; }
        th { background: #0c9153; color: white; }
        tr:nth-child(even) td { background: #f9f9f9; }

        /* Modais */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 1.5rem; border: 1px solid #888;
            width: 90%; max-width: 500px; border-radius: 8px;
        }
        .close { color: #aaa; float: right; font-size: 2rem; cursor: pointer; }
        .close:hover { color: black; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 0.7rem; font-size: 1rem; }
        
        .action-buttons {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 20px;
        }
        .action-buttons button {
            min-width: 160px; padding: 0.7rem 1.2rem; font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PATRIMÔNIOS SIGMAS - LOCALIZADOR</h1>
        
        <div id="login-section">
            <button onclick="solicitarToken()">Fazer Login com Google</button>
        </div>
        
        <div class="progress-container" id="progress-container" style="display: none;">
            <div id="spinner" class="spinner"></div>
            <p id="progressText">Consultando Servidor</p>
        </div>
        
        <div id="busca-section" style="display: none;">
            <input type="text" id="patrimonioInput" placeholder="Digite o Número do Patrimônio" autofocus>
            <button onclick="buscarPatrimonio()">Buscar Localização</button>
        </div>
        
        <table id="patrimonioTable" style="display: none;">
            <thead>
                <tr>
                    <th>NRP</th>
                    <th>Material</th>
                    <th>Localização</th>
                    <th>Responsável</th>
                </tr>
            </thead>
            <tbody id="patrimonioList"></tbody>
        </table>
        
        <div id="action-buttons" class="action-buttons" style="display: none;">
            <button onclick="abrirModalTransferencia()">Alterar Responsável</button>
            <button onclick="abrirModalMudarSala()">Mudar Sala</button>
            <button onclick="abrirModalAlteracoes()">Consultar Alterações</button>
        </div>
        
        <!-- Modais -->
        <div id="transferenciaModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="fecharModal('transferenciaModal')">×</span>
                <h2>Alterar Responsável</h2>
                <div class="form-group">
                    <label for="novoResponsavel">Novo Responsável:</label>
                    <input id="novoResponsavel" list="responsaveisList" placeholder="Digite ou selecione">
                    <datalist id="responsaveisList"></datalist>
                </div>
                <div class="form-group">
                    <label for="osTransferenciaResp">Nº OS de Transferência:</label>
                    <input type="text" id="osTransferenciaResp" placeholder="Digite o número da OS" required>
                </div>
                <button onclick="confirmarTransferencia()">Confirmar Transferência</button>
            </div>
        </div>
        
        <div id="mudarSalaModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="fecharModal('mudarSalaModal')">×</span>
                <h2>Mudar Sala</h2>
                <div class="form-group">
                    <label for="novaSalaMudanca">Nova Sala:</label>
                    <input type="text" id="novaSalaMudanca" placeholder="Digite a nova sala" required>
                </div>
                <div class="form-group">
                    <label for="osTransferenciaSala">Nº OS (opcional):</label>
                    <input type="text" id="osTransferenciaSala" placeholder="Digite o número da OS">
                </div>
                <button onclick="confirmarMudancaSala()">Confirmar Mudança</button>
            </div>
        </div>
        
        <div id="alteracoesModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="fecharModal('alteracoesModal')">×</span>
                <h2>Alterações do Patrimônio</h2>
                <p id="alteracoesInfo"></p>
            </div>
        </div>
        
        <button class="backButton" onclick="window.location.href='index.html'">Voltar</button>
    </div>
    
    <footer class="author-signature">© 2025 BrenoDoria</footer>

    <script>
        const usuarios = {
            "supervisor": { senha: "12345", permissao: "Supervisor" },
            "operador": { senha: "12345", permissao: "Operador" }
        };

        const CLIENT_ID = '286050228811-cv6vsd075480anb1i6auuc421enuaf8q.apps.googleusercontent.com';
        const FILE_ID = '1iNeSf0wakQ6j9Eg_qOCzVNKcIVVIsukeThL0Phpd5LE';
        
        let tokenClient, accessToken = null, dadosPlanilha = null, nrpSelecionado = null;

        window.onload = () => {
            // === PERMISSÃO ===
            const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
            if (!usuarioLogado || usuarios[usuarioLogado.username]?.permissao !== "Supervisor") {
                alert("Acesso negado: Você não tem permissão para acessar esta página.");
                window.location.href = "index.html";
                return;
            }

            // === GOOGLE AUTH ===
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (tokenResponse) => {
                    if (tokenResponse.error) return alert("Erro na autenticação: " + tokenResponse.error);
                    accessToken = tokenResponse.access_token;
                    localStorage.setItem("access_token", accessToken);
                    document.getElementById("login-section").style.display = "none";
                    document.getElementById("busca-section").style.display = "block";
                    carregarPatrimoniosDoSheets();
                }
            });

            const savedToken = localStorage.getItem("access_token");
            if (savedToken) {
                accessToken = savedToken;
                document.getElementById("login-section").style.display = "none";
                document.getElementById("busca-section").style.display = "block";
                carregarPatrimoniosDoSheets();
            }

            document.getElementById("patrimonioInput").addEventListener("keydown", e => {
                if (e.key === "Enter") buscarPatrimonio();
            });
        };

        function solicitarToken() { tokenClient.requestAccessToken(); }

        function carregarPatrimoniosDoSheets(retry = 0) {
            const maxRetries = 3;
            document.getElementById("progress-container").style.display = "block";
            document.getElementById("progressText").textContent = "Consultando Servidor";

            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/SIGMAS!A:F`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            })
            .then(async res => {
                if (!res.ok) {
                    if (res.status === 401 && retry < maxRetries) {
                        localStorage.removeItem("access_token");
                        solicitarToken();
                        return;
                    }
                    throw new Error("Erro ao carregar planilha");
                }
                const data = await res.json();
                dadosPlanilha = data.values || [];
                document.getElementById("progressText").textContent = "AUTORIZADA CONSULTA";
                document.getElementById("spinner").style.display = "none";
                document.getElementById("patrimonioTable").style.display = "table";
                populateResponsaveis();
            })
            .catch(() => {
                document.getElementById("progressText").textContent = "Erro ao carregar dados";
            });
        }

        function populateResponsaveis() {
            const respList = [...new Set(dadosPlanilha.slice(1).map(r => r[3]?.trim()).filter(Boolean))].sort();
            const datalist = document.getElementById('responsaveisList');
            datalist.innerHTML = '';
            respList.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                datalist.appendChild(opt);
            });
        }

        function buscarPatrimonio() {
            const input = document.getElementById("patrimonioInput");
            let nrp = input.value.trim();
            if (!nrp) return;

            const cleanedNrp = nrp.replace(/\./g, "").replace(/^0+/, "");
            const listElement = document.getElementById("patrimonioList");
            const actionButtons = document.getElementById("action-buttons");

            const index = dadosPlanilha.slice(1).findIndex(row => 
                row[0]?.toString().trim().replace(/\./g, "").replace(/^0+/, "") === cleanedNrp
            ) + 1;

            listElement.innerHTML = "";
            actionButtons.style.display = "none";

            if (index > 0) {
                const row = dadosPlanilha[index];
                nrpSelecionado = row[0];

                listElement.innerHTML = `
                    <tr>
                        <td>${row[0] || "N/A"}</td>
                        <td>${row[1] || "N/A"}</td>
                        <td>${row[2] || "Não especificada"}</td>
                        <td>${row[3] || "Não informado"}</td>
                    </tr>`;
                
                document.getElementById("progressText").textContent = `Patrimônio ${nrp} encontrado!`;
                actionButtons.style.display = "flex";
            } else {
                document.getElementById("progressText").textContent = `Patrimônio ${nrp} não encontrado.`;
            }

            input.value = "";
            input.focus();
        }

        function abrirModalTransferencia() {
            document.getElementById("transferenciaModal").style.display = "block";
            document.getElementById("novoResponsavel").value = "";
            document.getElementById("osTransferenciaResp").value = "";
        }

        function abrirModalMudarSala() {
            document.getElementById("mudarSalaModal").style.display = "block";
            document.getElementById("novaSalaMudanca").value = "";
            document.getElementById("osTransferenciaSala").value = "";
        }

        function abrirModalAlteracoes() {
            document.getElementById("alteracoesModal").style.display = "block";
            const index = dadosPlanilha.slice(1).findIndex(r => r[0] === nrpSelecionado) + 1;
            const row = dadosPlanilha[index] || [];
            const info = row[4] || row[5] 
                ? `OS: ${row[4] || '—'}<br>Registro: ${row[5] || '—'}`
                : "Nenhuma alteração registrada.";
            document.getElementById("alteracoesInfo").innerHTML = info;
        }

        function fecharModal(id) {
            document.getElementById(id).style.display = "none";
        }

        async function confirmarTransferencia() {
            const novoResp = document.getElementById("novoResponsavel").value.trim();
            const os = document.getElementById("osTransferenciaResp").value.trim();

            if (!novoResp || !os) return alert("Preencha Responsável e OS.");

            if (!confirm(`Transferir ${nrpSelecionado} para ${novoResp}?`)) return;

            const index = dadosPlanilha.slice(1).findIndex(r => r[0] === nrpSelecionado) + 1;
            if (index <= 0) return;

            const usuario = JSON.parse(localStorage.getItem("usuarioLogado")).username;
            const dataHora = new Date().toLocaleString('pt-BR');
            const registro = `Alterado "responsável" por ${usuario} em ${dataHora}`;

            const range = `SIGMAS!D${index + 1}:F${index + 1}`;
            const values = [[novoResp, os, registro]];

            await atualizarPlanilha(range, values);
            
            dadosPlanilha[index][3] = novoResp;
            dadosPlanilha[index][4] = os;
            dadosPlanilha[index][5] = registro;
            
            alert("Responsável alterado com sucesso!");
            fecharModal('transferenciaModal');
            buscarPatrimonio();
        }

        async function confirmarMudancaSala() {
            const novaSala = document.getElementById("novaSalaMudanca").value.trim();
            const os = document.getElementById("osTransferenciaSala").value.trim();

            if (!novaSala) return alert("Digite a nova sala.");

            if (!confirm(`Mudar sala de ${nrpSelecionado} para ${novaSala}?`)) return;

            const index = dadosPlanilha.slice(1).findIndex(r => r[0] === nrpSelecionado) + 1;
            if (index <= 0) return;

            const usuario = JSON.parse(localStorage.getItem("usuarioLogado")).username;
            const dataHora = new Date().toLocaleString('pt-BR');
            const registro = `Alterado "sala" por ${usuario} em ${dataHora}`;

            const range = `SIGMAS!C${index + 1}:F${index + 1}`;
            const values = [[novaSala, dadosPlanilha[index][3], os || '', registro]];

            await atualizarPlanilha(range, values);
            
            dadosPlanilha[index][2] = novaSala;
            dadosPlanilha[index][4] = os;
            dadosPlanilha[index][5] = registro;
            
            alert("Sala alterada com sucesso!");
            fecharModal('mudarSalaModal');
            buscarPatrimonio();
        }

        async function atualizarPlanilha(range, values) {
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${FILE_ID}/values/${range}?valueInputOption=RAW`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ values })
            });
            if (!response.ok) throw new Error("Falha ao salvar no Sheets");
        }
    </script>
</body>
</html>
